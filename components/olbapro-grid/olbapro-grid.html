
<polymer-element name="olbapro-grid" attributes="rows insertAllowed data">

<template>
  <style>


  :host {
    position: absolute;
    
   
    box-sizing: border-box;
    margin: 0;
  }

  .cell {
    border: 1px solid black;
    background-color:lightblue;
    font-family: Tahoma;
    width: 100px;
    font-size: 14px;


  }

  .cellPosition {
    border: 1px solid black;
    background-color:lightblue;
    font-family: Tahoma;
    width: 100px;
    font-size: 14px;
    text-align:right;

  }

  .header {
    border: 1px solid black;
    font-family: Tahoma;
    width: 100px;
    display:block;
    font-size: 14px;
    background-color:orange;
  }


  </style>

  <div id="headerDiv" horizontal layout></div>
  <div id="mydiv" >

  </div> 
  <paper-slider id="slider" min="1" max="{{maxSlider}}" value="1" on-change="{{changeSlider}}"></paper-slider>
</template>


<script>
Polymer('olbapro-grid', {
  rows:1,
  columnsName:[],
  lastRowPainted:-1,
  data:[],
  firstRow:0,
  insertAllowed:true,
  maxSlider:5,
  ready: function () {
    var columns=this.children[0];

    var span=this.$.headerDiv.appendChild(document.createElement("span"));
    span.innerHTML ="";
    span.className="header";             

    span.style.width="24px";
    span.style.height="30px";

    for (var i=0;i<columns.children.length;i++){
      this.columnsName.push(columns.children[i].id);

      var span=this.$.headerDiv.appendChild(document.createElement("span"));
      span.innerHTML =columns.children[i].label;
      span.className="header";             

      var width=columns.children[i].style.width;

      if (width!=""){
        span.style.width=width;
      }
      span.style.height="30px";
    }


    for (var j=0;j<this.rows;j++){
      var row=this.$.mydiv.appendChild(document.createElement("div"));
      row.id="row"+pad(j,3);
      row.style.height="30px";

      var span=row.appendChild(document.createElement("paper-input")); 
      span.id="pos"+pad(j,3);       
      span.className="cellPosition";               
      span.style.width="24px";
      span.style.height="30px";
      span.disabled=true;

      for (var i=0;i<columns.children.length;i++){
        var obj=document.createElement("paper-input");
        obj.id=columns.children[i].id+pad(j,3);
        obj.label="";
        obj.className="cell";
     
        var width=columns.children[i].style.width;
        if (columns.children[i].attributes.getNamedItem("updatenotallowed")==null){
          obj.updatenotallowed=false;
        }else{
          obj.updatenotallowed=true;
        }

         if (columns.children[i].attributes.getNamedItem("insertnotallowed")==null){
          obj.insertnotallowed=false;
        }else{
          obj.insertnotallowed=true;
        }

        if (width!=""){
          obj.style.width=width;
        }
        obj.style.height="30px";

        obj.onkeydown=function(event){this.offsetParent.keyDown(event)};
        obj.onfocus=function(event){this.offsetParent.focus(event)};
        obj.onblur=function(event){this.offsetParent.blur(event)};

        row.appendChild(obj);
      }             
    }


    if (this.insertAllowed){
      this.maxSlider=this.data.length-this.rows+2;
    }else{
      this.maxSlider=this.data.length-this.rows+1;
    }
    
    this.refreshData();

  },
  /* Check key for arrows,scape */
  keyDown:function(event){

    if (event.keyCode=="40"){ /* Down key */

      var pos=parseInt(right(event.currentTarget.id,3));
      var colum=left(event.currentTarget.id,event.currentTarget.id.length-3)
      var ctr=this.shadowRoot.querySelector("#"+event.currentTarget.id);

      if (pos<this.rows-1){ /* if we are no on the last row */
        this.shadowRoot.querySelector("#"+colum+pad(pos+1,3)).$.input.focus(); /* Focus next line control */
      }else{ /* if we are on the las row */
        if (!this.insertAllowed){  /* If we can not insert */
          if (this.firstRow<this.data.length-this.rows){ /* there is more rows to show */
            if (this.setFirstRow(this.firstRow+1)){ /* try to change first row */
              this.refreshData();  /*Refresh data */
            }            
          }
        }else{ /* Insert allowed */
         if (this.firstRow==this.data.length-this.rows){ /* we are on de lastrow */
          this.shadowRoot.querySelector("#"+this.columnsName[0]+pad(pos,3)).$.input.focus(); /* focus on the prior line */
          }
          if (this.firstRow<this.data.length-this.rows+1){ /* if there is prior rows */
           if (this.setFirstRow(this.firstRow+1)){ /* try to change first row */
            this.refreshData(); /* Refresh Data */
          }
      }              
    }
  }
}else if (event.keyCode=="38"){ /* Up key */
  var pos=parseInt(right(event.currentTarget.id,3));
  var colum=left(event.currentTarget.id,event.currentTarget.id.length-3)
  var ctr=this.shadowRoot.querySelector("#"+event.currentTarget.id);

  if (pos>0){ /* if we are not on the first line */
    this.shadowRoot.querySelector("#"+colum+pad(pos-1,3)).$.input.focus(); /* change control to the prior line */
  }else{  /* we are on the first line */
    if (this.firstRow>0){  /* if we are not on the first row */
      if (this.setFirstRow(this.firstRow-1)){ /* Change first row */
        this.refreshData(); /* Refresh Data */
      }
    }
  }
}else if (event.keyCode=="27"){ /* scape */
  var pos=parseInt(right(event.currentTarget.id,3));
  var colum=left(event.currentTarget.id,event.currentTarget.id.length-3)
  this.shadowRoot.querySelector("#"+colum+pad(pos,3)).value=this.data[this.firstRow+pos][colum];
  /* reset value */
}
},
focus:function(event){

  var pos=parseInt(right(event.currentTarget.id,3));
  if (this.lastRowPainted!=pos){
    for (var i=0;i<this.columnsName.length;i++){
      if (!this.shadowRoot.querySelector("#"+this.columnsName[i]+pad(pos,3)).invalid){
        this.shadowRoot.querySelector("#"+this.columnsName[i]+pad(pos,3)).style.background="lightgreen";
      }

      if (this.lastRowPainted!=-1){
        if (!this.shadowRoot.querySelector("#"+this.columnsName[i]+pad(this.lastRowPainted,3)).invalid){
          this.shadowRoot.querySelector("#"+this.columnsName[i]+pad(this.lastRowPainted,3)).style.background="lightblue";
        }
      }                  
    }

    this.lastRowPainted=pos;
  }
},
refreshData:function(){

  for (var i=0;i<this.data.length-this.firstRow && i<this.rows;i++){
    var ele=this.data[this.firstRow+i];
    for (var j=0;j<this.columnsName.length;j++){
      var ctr=this.shadowRoot.querySelector("#"+this.columnsName[j]+pad(i,3));
      ctr.value=ele[this.columnsName[j]];
      if (ctr.updatenotallowed){
        ctr.readonly=true;
      }else{
        ctr.readonly=false;
      }
    }  
    this.shadowRoot.querySelector("#pos"+pad(i,3)).value=this.firstRow+i+1;      
  }

  for (var i=this.data.length-this.firstRow; i<this.rows;i++){
    for (var j=0;j<this.columnsName.length;j++){
      var ctr=this.shadowRoot.querySelector("#"+this.columnsName[j]+pad(i,3))
      ctr.value="";
      if (ctr.insertnotallowed){
        ctr.readonly=true;
      }else{
        ctr.readonly=false;
      }
    }    
    this.shadowRoot.querySelector("#pos"+pad(i,3)).value="*";           
  }
},
blur:function(event){

  var pos=parseInt(right(event.currentTarget.id,3));
  var colum=left(event.currentTarget.id,event.currentTarget.id.length-3)
  var value=this.shadowRoot.querySelector("#"+event.currentTarget.id).value

  if (this.firstRow+pos<this.data.length){
    if (value!=this.data[this.firstRow+pos][colum]){
     var obj={
      "column":colum,
      "row":this.firstRow+pos,
      "value":value,
      "control":this.shadowRoot.querySelector("#"+event.currentTarget.id)
    };
    obj.control.invalid=false;
    this.fire("validatecell",obj);



    if (obj.control.invalid){
      obj.control.style.background="red";
    }else{
      obj.control.style.background="lightgreen";
      this.data[this.firstRow+pos][colum]=value;
      this.data[this.firstRow+pos].status="U";
    }
  }else{
    this.shadowRoot.querySelector("#"+event.currentTarget.id).invalid=false;
    this.shadowRoot.querySelector("#"+event.currentTarget.id).style.background="lightgreen";
    
  }
}else{
  if (value!=""){
    var newObj={};
    for(var j=0;j<this.columnsName.length;j++) {
      newObj[this.columnsName[j]]="";
    } 

    this.data.push(newObj);
    this.data[this.firstRow+pos][colum]=value;
    this.data[this.firstRow+pos].status="I";
  }
}         

},
isInvalid:function(){
  for (var i=0;i<this.rows;i++){
    for (var j=0;j<this.columnsName.length;j++){
      if (this.shadowRoot.querySelector("#"+this.columnsName[j]+pad(i,3)).invalid){
        return true;
      }
    }
  }
  return false;
},
/* change first visible row */
setFirstRow:function(value){
  if (!this.isInvalid()){
    this.firstRow=value;
    return true;
  }else{
    return false;
  }
},
changeSlider:function(){
  if (this.setFirstRow(this.$.slider.value-1)){
    this.refreshData();
  }else{

  }
}
});

</script>

</polymer-element>

<script>
function pad(n, width, z) {
  z = z || '0';
  n = n + '';
  return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n;
}

function left(str, n)
{
  if (n <= 0)
    return "";  
  else if (n > String(str).length)
    return str;
  else
    return String(str).substring(0,n);
}

function right(str, n)
{
  if (n <= 0)
    return "";
  else if (n > String(str).length)
    return str;
  else
  {
    var iLen = String(str).length;
    return String(str).substring(iLen, iLen - n);
  }
}
</script>